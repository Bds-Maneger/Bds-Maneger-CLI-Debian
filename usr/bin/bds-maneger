#!/bin/bash
echo "Olá $USER"
ROOTS="0"
BDS_COMMON_INSTALLED=$(command -v bds;echo $?)
if [ $BDS_COMMON_INSTALLED = '0' ]
then
 echo "..."
else
 echo "Por Favor Instale o bds-common com apt install bds-common"
 exit 127
fi
if [ "$EUID" -ne $ROOTS ]; then
echo "Você não está executando o script com root ou sudo, por favor execute de novo o com: $0 $1"
exit 23
fi

# --------------- Codigo ------------------------------
TMP=/tmp/Minecraft-temp
mkdir /tmp &> /dev/null
rm -rf $TMP/level.txt >> $USUARIO/log.txt 2>&1 ;
json(){
    PORTAD="$(cat "/etc/bds-maneger/install.json" | jq ".global.port" | sed 's|"||g')"
    DOMAINTEST=$(cat "/etc/bds-maneger/install.json" | jq ".pages.domain" | sed 's|"||g')
    IPDOMAIN=$([ $DOMAINTEST = 'null' ] && wget -qO- http://ipecho.net/plain || echo $DOMAINTEST)
    echo ""
    echo "Pasta dos Arquivos:                      /etc/BDS-Common"
    echo "Porta do Servido:                        $PORTAD"
    echo "Dominio ou IP que será Utilizado:        $IPDOMAIN"
}

ipbysh23(){
      #Comando --ip variaveis
      IP_V4=$(ip addr | grep 'inet' | grep -v inet6 | grep -vE '127\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}' | grep -oE '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}' | head -1)
      SEARCH_IPV6=$(ip -6 route ls | grep default | grep -Po '(?<=dev )(\S+)' | head -1)
      IP_V6=$(ifconfig $SEARCH_IPV6 | grep "inet6" | awk -F' ' '{print $2}' | awk '{print $1}') 
      IP_PUBLICO=$(wget -qO- http://ipecho.net/plain)
      #Echo's
            echo "Seu IPv4 é $IP_V4 para Jogar localmente , e o Seu IPv6 é $(echo -ne $IP_V6)"
            echo " "
            echo "Caso Queira Jogar Remotamento com alguém Abra as Portas 19132 e 19133 no seu Roteador ou seu Firewall, seu IPv4 Publico é $IP_PUBLICO"
            echo "Também verifique se sua operadora ou provedor libera as portas do servidor. contate-os"
      echo " ";
}
apache2-installbysh23(){

      #Instalação do apache2
      echo "Instalando o Apache2"
       apt update >> /dev/null 2>&1 
       apt install apache2 -y >> /dev/null 2>&1 

      # Removendo pasta HTML e Adicionando denovo
      rm -rf /var/www/html/
      mkdir /var/www/html/

      # Pegando as config
      echo "Agora vamos começar a configurar o nova pagina do Apache"
      # Montando as Configurações
      sed -i "s|ENDEREÇODOSERVIDOROUIP|$IPDOMAIN|g" "/usr/opt/bds-maneger/html-files/index.html"
      sed -i "s|PORTASERVER|$PORTAD|g" "/usr/opt/bds-maneger/html-files/index.html"

      # Movendo as configurações
      cp -rf /usr/opt/bds-maneger/html-files/* /var/www/html/
}
externobysh23(){
      # vsftp
       apt install -y vsftpd samba >> /dev/null 2>&1 ;

      #config
      sed -i "s|root||g" "/etc/ftpusers"

      rm /etc/samba/smb.conf
      cp -rf /usr/opt/bds-maneger/smb.conf /etc/samba/
      cp -rf /usr/opt/bds-maneger/vsftp.conf /etc/vsftpd.conf

      service smbd restart
      service vsftpd restart

echo "Para adicionar um usuario no Smb use smbpasswd -a username"
echo "Para usar o ftp não precisar de nada a mais para configura só ter um usuario no sistema"

}
sistemabysh23(){
    echo "Iniciando as Configurações do arquivo para Inicialização junto com o Sistema"
    cp /usr/opt/bds-maneger/start-on-system.sh /etc/init.d/bds
    chmod a+x /etc/init.d/bds;
    update-rc.d bds defaults
    update-rc.d bds enable
    echo "pronto ele inicia junto com sistema, o comando abaixo pode ajudar"
    echo " "
    echo ' service bds start|stop|restart'
    echo " "
    echo "Para desativar o Inicio altomatico execute $0 --remover-service ou  $0 -R"
    
}
removerservicesh23(){
update-rc.d bds defaults-disabled
update-rc.d bds disable
rm -rf /etc/init.d/bds
}

if [[ -e /etc/bds-maneger/install.json ]];then
json
else
echo "Por favor coloque um aquivo com o nome install.json na pasta /etc/bds-maneger ou se não, copia e renomeia o arquivo exemplo_install.jsonc"
exit 127
fi

while [ true ]; do
read -rp "
-I : Iniciar o Servidor manualmente em uma sessão Screen
-S : Para o Servidor em sessão Screen
-u : Atualizar o Software do bds
-b : Ativar o Backup dos Software Por completo (Recomendado)
-s : Ativar a inicialização do bds junto com o Sistema Operacional
-P : mostra seu Ip local e público
-a : Instalar o Apache Web Server para adicionar o minecraft ao abrir no navegador seu ip/dominio
-R : Remover a inicialização do servidor junto com o sistema operacional
-h : ajuda um pouco mais detalhada
-e : sair do menu


Qual é Sua Opção: " -e -i "" LE
#
case $LE in
-I ) echo "Estamos Iniciando seu Servidor!";screen -dmS bedrock bds ;;
-U ) echo "Estamos Parando seu Servidor";screen -S bedrock -p 0 -X stuff 'stop\n' ;;
-u ) echo "Por Favor Aguarde ...";apt update &> /dev/null && apt install bds-common -y &> /dev/null && echo "Pacote atualizado para a ultima versão" || echo "Não podemos atualizar os Software";;
-s ) sistemabysh23 ;;
-P ) ipbysh23 ;;
-a ) apache2-installbysh23 ;;
-f ) externobysh23 ;;
-R ) removerservicesh23 ;;
-c ) crontabsh23 ;;
-h ) cat /usr/opt/bds-maneger/help.txt ; echo " ";;
-e ) break;;
 * ) echo "Essa opção não existe";echo " "
esac
done
# --------------- Codigo ------------------------------
echo " "
echo "--------------"
echo " "
echo "qualquer erro no script me comunique no https://github.com/Sirherobrine23/Minecraft-Bedrock-auto-install/issues"
echo " "
exit 0
